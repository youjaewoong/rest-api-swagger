<!DOCTYPE html>
<html>
<head>
    <title>Hello Request Example</title>
    <!-- link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" 
    	integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" 
    	crossorigin="anonymous"> -->
    <link href="/builder/custom.css" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
    <script
	  src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
	  integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
	  crossorigin="anonymous"></script>
	  
	<link rel="stylesheet" href="http://cdn.dhtmlx.com/edge/dhtmlx.css" type="text/css"> 
	<script src="/builder/dhtmlx.js" type="text/javascript"></script>
    
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/json2html/2.2.1/json2html.min.js"></script>
    <script src="/builder/builder.js"></script>
    <script src="/builder/common.js"></script>
	<script src="/builder/template-01.js"></script>
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1,height=device-height,width=device-width,viewport-fit=cover">
	<meta name="referrer" content="origin" />
	<meta name="referrer" content="origin-when-cross-origin" />
	<meta name="format-detection" content="telephone=no"/>
	
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="pragma" content="no-cache" />
	
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">
<style>
#render.row.form {
  margin-top: 0px;
}
</style>

<script>
var grdList;
var fieldList;
var listFilesTempArr = {};

function initFormDataSetting(){
    $("#builderForm #serviceId").val('serviceId12');
    $("#builderForm #bizCode").val('${serviceInfo.bizCode }');
    
    $("#builderForm #isCharge").val('${isCharge }');
    $("#builderForm #isSupport").val('${isSupport }');
        
    $('#builderForm #listRowid').val('');
}

function initFormButton(){
    // 버튼 정보조회
    $.ajax({
        method: "POST",
        url : "/user/service/code/getFormButtonList.do",
        data : {"serviceId" : "serviceId12"},
        dataType: "json",
        async: false,
        success : function(response){
            var returnObj = response.returnObj;
            if (returnObj.returnCode == "SUCCESS") {
                var buttonList = returnObj.formButtonList;
                $.each(buttonList,function(i,v){
                    // 버튼생성
                    var r= $('<button class="trans_btn" id="'+v.buttonCode+'">'+v.buttonName+'</button>');
                    $("#buttonListArea").append(r);
                    
                    // 버튼 이벤트 
                    $(document).on("click", "#"+v.buttonCode, function(){
                        retrieve(this.id);
                    });
                });
            }
        }, 
        error: function(a) {
            alert(a.errorMessage);
        }
    }); 
}

function initFormInfo(){
    // 업무신청화면 정보조회
    $.ajax({
        method: "POST",
        url : "/user/service/code/getFormInfo.do",
        data : {"serviceId" : "serviceId12"},
        dataType: "json",
        async: false,
        success : function(responseData){
            var serviceFormInfo = responseData.serviceFormInfo;
            
            // 업무화면명 출력
            var bookmarkHtml = ' <span class="bookmark_btn_box"><i class="fas fa-star"></i></span>';
            $('#service_display_name').html(serviceFormInfo.serviceDisplayName+bookmarkHtml);
            
            // 폼 빌더에서 만든 입력화면 구성 출력
            var jsonStr = serviceFormInfo.json;

            try {
                jsonObj = htmlToJson(tagReplaceAll(jsonStr));
            } catch(e){
                jsonObj = undefined;
            }
            $('#render').json2html({}, jsonObj);

            // 업무별 javascript Include
            $('body').append($("<script>"+serviceFormInfo.jscript+"<\/script>")[0]);
            
            $('body').append($("<script>$(document).ready(function() {$('.loading_screen').hide();})<\/script>")[0]);
            
            /* READONLY/DISABLED LABEL 비활성화 */
            $('body').append($("<script>$(document).ready(function() {itemDisabledFnc();})<\/script>")[0]);            

        }, 
        error: function(a) {
            alert(a.message);
        }
    });
}

function initGrid(){
    // 리스트 Build
    $.ajax({
        method: "POST",
        url : "/user/service/code/getFormFieldList.do",
        data : {"serviceId" : "serviceId12"},
        dataType: "json",
        async: false,
        success : function(responseData){
            var returnObj = responseData.returnObj;
            
            if (returnObj.returnCode == "SUCCESS") {
                fieldList = returnObj.formFieldList;
                
                // DB 필드정보로 그리드 생성
                setGridBuild(fieldList);            	
            }else {
            	alert(responseData.returnMessage)
            }

        }, 
        error: function(a) {
            alert(a.message);
        }
    });
}

function setGridBuild(fieldList) {
    grdList = new dhtmlXGridObject('gridList');
    grdList.setImagePath("/assets/dhtmlx/imgs/");
    grdList.setSkin("skyblue");
    
    var colHeader = "";
    var colNames = "";
    var colWidth = "";
    var colStyle = "";
    var colAlign = "";
    var colType = ""; 
    var colFilter = ""; 
    var colSort = "";

    // 첫번째 컬럼 checkBox
    colHeader += "<spring:message code='CMMN.application.all_check'/>,";
    colNames += "Check,";
    colWidth += "60,";
    colStyle += ',';
    colAlign += "center,";
    colType += "ch,";
    colFilter += "na,";
    colSort += "na,";  
    
    $.each(fieldList,function(i,v){
        var elementId = v.elementId;
        var fieldId = v.fieldId;
        
        colHeader += v.attrLabel+",";
        colNames += v.fieldId+",";
        colWidth += "*,";
        
        var fieldFormat = v.fieldType;
        if(!isEmpty(v.fieldDefault)) {
        	fieldFormat = v.fieldDefault;
        } 
        	
        // 숫자일경우  column type
        if(fieldFormat == "NUMBER") {
            colType += "ronum,";
            colAlign += "right,";
            colSort += "int,";
            
        // 날짜일경우 column type            
        }else if(fieldFormat == "DATE") {
            colType += "rod,";
            colAlign += "center,";
            colSort += "date,"; 
        
        }else {
            colType += "ro,";
            colAlign += "center,";
            colSort += "str,";
        }

        colFilter += "#text_filter,";
    });
    
    colHeader = colHeader.substring(0, colHeader.length-1);
    colFilter = colFilter.substring(0, colFilter.length-1);
    colNames = colNames.substring(0, colNames.length-1);
    colAlign = colAlign.substring(0, colAlign.length-1);
    colType = colType.substring(0, colType.length-1);
    colSort = colSort.substring(0, colSort.length-1);
    colWidth = colWidth.substring(0, colWidth.length-1);

    grdList.setHeader(colHeader);
    grdList.setColumnIds(colNames);
    grdList.attachHeader(colFilter);
    grdList.setColAlign(colAlign);
    grdList.setColTypes(colType);
    grdList.setColSorting(colSort);
    grdList.setInitWidths(colWidth);
    
    // 페이징
    grdList.enablePaging(true, 10, 10, "pagingArea", true, "infoArea");
    grdList.setPagingSkin("bricks");
    
    // 컬럼 숨김
    $.each(fieldList,function(i,v){
        if(v.listDisplayAt!="Y") {
            grdList.setColumnHidden(grdList.getColIndexById(v.fieldId),true);
        }
    });
    
    // 행 클릭 시 이벤트
    grdList.attachEvent("onRowSelect",function(rowId, cInd){
    	listToDetail(rowId, cInd);
        return true;
    });
    
    // 행 생성시 이벤트(모바일 화면에서 그리드 보기 수정 - 2020.03.17)
    /*grdList.attachEvent("onRowInserted",function(row,rInd){      
        gridAddMobileClassInit();
    });*/
    
    grdList.init();
    
    var div = '<div class="checkbox_box"><input type="checkbox" name="allChecked" id="allChecked" value="Y"><label for="allChecked"></label></div>';
    $('table.hdr tbody tr:eq(2) td:eq(0)').append(div);
    $('table.hdr tbody tr td:first-child').addClass('td_chk');
}

function initForm(){
	// 리스트조회 및 초기 Data set
	initFormDataSetting(); 
    
    // 버튼 정보조회
	initFormButton();

    // 업무신청화면 정보조회
    initFormInfo();

    // 리스트 Build
    initGrid();
} 

function getWhereParamObj(code) {
	var whereParamObj = {};
    whereParams = JSON.stringify(whereParamObj);
    return whereParams;
}


//버튼 클릭시 validate 체크
function actionValidate(buttonId){
	return true;
}

// 버튼 클릭시 함수 모음
// 초기화
function clearFormFunc(){}

//clearFormFunc 이전/이후 
function clearFormFuncBefore(){}
function clearFormFuncAfter(){}


// 계산하기
function calcClickFunc(){}

//해지
function procEndFunc(){}
//버튼 클릭시 함수 모음

// 파일 다운로드
function fileDownload() {}

//이벤트등록(화면 로딩후)
function initEvent(){}

// 초기 입력값 세팅(화면 로딩후)
function setUserInfoSetting(){
    $("#builderForm #userId").val('${userInfo.userId }');
    $("#builderForm #userName").val('${userInfo.userName}');
    $("#builderForm #posCode").val('${userInfo.posCode}');
    $("#builderForm #posName").val('${userInfo.posName }');
    $("#builderForm #deptCode").val('${userInfo.deptCode }');
    $("#builderForm #deptName").val('${userInfo.deptName}');
    $("#builderForm #workplaceCode").val('${userInfo.workplaceCode }');
    $("#builderForm #workplaceName").val('${userInfo.workplaceName}');	
}

//리스트 -> 입력 : 더블클릭 후 업무별 처리할 script
function listToDetailAfter(rowId){
}

//입력 -> 리스트 : 추가정보 등록(업무별로 추가할사항 있으면 아래 함수를 등록해서 만듬)
function appendApprovalData(data) {
	return data;
}
function appendUpdateApprovalData(data) {
	return data;	
}


//저장시 Row Data 변경
function updateColumnData(jsonObj){
	return jsonObj;
}

// 
function selectDataAfter(jsonDataObj){
	return jsonDataObj;	
}

// 조회 검색조건 추가시 사용
function addSearchParam(obj){
	return obj;
}

// 조회후 정렬 설정
function setCustomSort(){
}


$(document).ready(function() {
	
	// 화면 정보 set
    initForm();
    
    // 공통코드 set
    //setCommonCode();
    
    // 사용자 정보 setting
    setUserInfoSetting();    
    
 	// date picker 매핑(수정필요)
    $('#render [data-toggle="datepicker"]').datepicker({language: 'ko-KR'});

	$("#render [custom-input='true'][type=number]").on("keyup", function() {
        $(this).val($(this).val().replace(/[^0-9]/g,""));
	});
	
	// SelectBox Readonly 처리
    $.each($("#render select[custom-input='true'][readonly='readonly']"),function(){
		$(this).attr('disabled', true);
    });
 	
	// 상태에 따른 등록/수정버튼 처리 
    $('#buttonListArea #INSERT').show();
    $('#buttonListArea #UPDATE').hide();
    
  	// builder hidden box
    $('#render #hiddenLineBox').hide();
    
    // 전체선택
    $("#allChecked").on('click',function(){
		grdList.checkAll($("input:checkbox[id='allChecked']").is(":checked"));
	});	
    
    // 페이지 로딩시 리스트 조회 (수정, WF_FORM.JAVASCRIPT에 넣으세요)
    //ajaxListData();
});
</script>

</head>

<body class="bg admin_page">
<div class="wrapper sub_page">
        <div class="container">
            <div class="sub_box">
                <div class="sub_header block pro">
                    <!--  업무명 -->
                    <h1><div id="service_display_name"></div></h1>
                    <div class="pro_btn_box horiz" style="width: 280px;">
                        <div class="pro_box">
                        </div>
                    </div>
                </div>
				<hr>

                <div class="sub_body">
                    <div class="row">
                        <div class="form_box">
                            <div class="m_scroll">
                                <div class="row form" id="render"></div>
                            </div>
                        </div>
                    </div>
                </div>
<br><br>
                <div class="sub_header">
                    <span class="header_sm m_no">&nbsp;</span>
                    <div class="btn_box m_no">
                        <div class="filebox" id="buttonListArea">
                        </div>
                    </div>
                </div>
                <div class="sub_body">
                    <div class="row no_bg no_pd">
                        <div id="gridList" style='height:240px; width:100%;'></div>
                        <div class="total_count_box">조회건수 : <span id="totalCountRows">0</span></div>
                        <div><span id="pagingArea"></span>&nbsp;<span id="infoArea"></span></div>
                    </div>
                </div>

            </div>
        </div>
</div>

<div class="loading_screen">
    <div class="loading_spinner_box">
    <div class="loading_spinner">
	<div></div>
	</div></div>
</div>

<div class="modal_box" id="modal_find_staff"></div>

<div id="builderForm">
    <input type="hidden" id="listRowid">        <!-- 리스트 클릭시 set -->
    <input type="hidden" id="serviceId">
    <input type="hidden" id="bizCode">
    
    <input type="hidden" id="companyCode">
    <input type="hidden" id="userId">
    <input type="hidden" id="userName">
    <input type="hidden" id="posCode">
    <input type="hidden" id="posName">
    <input type="hidden" id="deptCode">
    <input type="hidden" id="deptName">
    <input type="hidden" id="workplaceCode">
    <input type="hidden" id="workplaceName">
    <input type="hidden" id="extNo">
    
    <input type="hidden" id="isCharge">
    <input type="hidden" id="isSupport">
</div>

<input type="hidden" name="searchMode" id="searchMode" value="">


</body>
</html>
